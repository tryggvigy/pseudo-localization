{"version":3,"file":"index.js","names":["pseudoLocalization","mutationObserverOpts","blacklistedNodeNames","opts","strategy","enabled","observer","observerConfig","characterData","childList","subtree","textNodesUnder","element","walker","document","createTreeWalker","NodeFilter","SHOW_TEXT","node","isAllWhitespace","nodeValue","test","FILTER_REJECT","isBlacklistedNode","parentElement","includes","nodeName","FILTER_ACCEPT","currNode","textNodes","nextNode","push","isNonEmptyString","str","pseudoLocalize","textNodesUnderElement","textNode","pseudoLocalizeString","domMutationCallback","mutationsList","mutation","type","addedNodes","length","disconnect","forEach","observe","body","target","isEnabled","start","extendParams","console","error","MutationObserver","stop","localize"],"sources":["../../src/index.ts"],"sourcesContent":["import pseudoLocalizeString, {\n  getStrategy,\n  PseudoLocalizeStringOptions,\n} from './localize.js';\n\n/**\n * export the underlying pseudo localization function so this import style\n *  import { localize } from 'pseudo-localization';\n * can be used.\n */\nexport { default as localize } from './localize.js';\n\ntype MutationObserverCallbackOptions = {\n  blacklistedNodeNames?: string[];\n};\n\ntype StartOptions = MutationObserverCallbackOptions &\n  PseudoLocalizeStringOptions;\n\nconst pseudoLocalization = (() => {\n  const mutationObserverOpts = {\n    blacklistedNodeNames: ['STYLE'],\n  };\n\n  const opts: PseudoLocalizeStringOptions = {\n    strategy: 'accented',\n  };\n\n  // Indicates whether the pseudo-localization is currently enabled.\n  let enabled = false;\n\n  // Observer for dom updates. Initialization is defered to make parts\n  // of the API safe to use in non-browser environments like nodejs\n  let observer: MutationObserver | null = null;\n  const observerConfig = {\n    characterData: true,\n    childList: true,\n    subtree: true,\n  };\n\n  const textNodesUnder = (element: Node) => {\n    const walker = document.createTreeWalker(\n      element,\n      NodeFilter.SHOW_TEXT,\n      node => {\n        const isAllWhitespace = node.nodeValue && !/[^\\s]/.test(node.nodeValue);\n        if (isAllWhitespace) {\n          return NodeFilter.FILTER_REJECT;\n        }\n\n        const isBlacklistedNode =\n          node.parentElement &&\n          mutationObserverOpts.blacklistedNodeNames.includes(\n            node.parentElement.nodeName\n          );\n        if (isBlacklistedNode) {\n          return NodeFilter.FILTER_REJECT;\n        }\n\n        return NodeFilter.FILTER_ACCEPT;\n      }\n    );\n\n    let currNode;\n    const textNodes = [];\n    while ((currNode = walker.nextNode())) textNodes.push(currNode);\n    return textNodes;\n  };\n\n  const isNonEmptyString = (str: unknown): str is string =>\n    !!str && typeof str === 'string';\n\n  const pseudoLocalize = (element: Node) => {\n    const textNodesUnderElement = textNodesUnder(element);\n    for (let textNode of textNodesUnderElement) {\n      const nodeValue = textNode.nodeValue;\n      if (isNonEmptyString(nodeValue)) {\n        textNode.nodeValue = pseudoLocalizeString(nodeValue, opts);\n      }\n    }\n  };\n\n  const domMutationCallback: MutationCallback = mutationsList => {\n    if (!observer) {\n      return;\n    }\n    for (let mutation of mutationsList) {\n      if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {\n        // Turn the observer off while performing dom manipulation to prevent\n        // infinite dom mutation callback loops\n        observer.disconnect();\n        // For every node added, recurse down it's subtree and convert\n        // all children as well\n        mutation.addedNodes.forEach(pseudoLocalize);\n        observer.observe(document.body, observerConfig);\n      } else if (mutation.type === 'characterData') {\n        const nodeValue = mutation.target.nodeValue;\n        const isBlacklistedNode =\n          !!mutation.target.parentElement &&\n          mutationObserverOpts.blacklistedNodeNames.includes(\n            mutation.target.parentElement.nodeName\n          );\n        if (isNonEmptyString(nodeValue) && !isBlacklistedNode) {\n          // Turn the observer off while performing dom manipulation to prevent\n          // infinite dom mutation callback loops\n          observer.disconnect();\n          // The target will always be a text node so it can be converted\n          // directly\n          mutation.target.nodeValue = pseudoLocalizeString(nodeValue, opts);\n          observer.observe(document.body, observerConfig);\n        }\n      }\n    }\n  };\n\n  const isEnabled = () => {\n    return enabled;\n  };\n\n  const start = ({\n    strategy = 'accented',\n    extendParams,\n    blacklistedNodeNames = mutationObserverOpts.blacklistedNodeNames,\n  }: StartOptions = {}) => {\n    if (isEnabled()) {\n      console.error('pseudo-localization is already enabled');\n      return;\n    }\n\n    mutationObserverOpts.blacklistedNodeNames = blacklistedNodeNames;\n    opts.strategy = strategy;\n    opts.extendParams = extendParams;\n    // Pseudo localize the DOM\n    pseudoLocalize(document.body);\n    // Start observing the DOM for changes and run\n    // pseudo localization on any added text nodes\n    observer = new MutationObserver(domMutationCallback);\n    observer.observe(document.body, observerConfig);\n    enabled = true;\n  };\n\n  const stop = () => {\n    if (!isEnabled()) {\n      console.error('pseudo-localization is already disabled');\n      return;\n    }\n\n    observer && observer.disconnect();\n    enabled = false;\n  };\n\n  return {\n    start,\n    stop,\n    isEnabled,\n    localize: pseudoLocalizeString,\n  };\n})();\n\nexport default pseudoLocalization;\n"],"mappings":"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"}